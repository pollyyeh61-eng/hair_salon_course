<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美髮創業遊戲化課程</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* 你原來的 CSS 樣式，這裡不做修改 */
        /* ==================== 共用樣式 ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }

        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button:hover:not(:disabled) {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* ==================== 儀表板樣式 ==================== */
        #dashboard {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #eef1f4;
        }

        .user-info h2 {
            margin-bottom: 5px;
            font-size: 1.8em;
        }

        .user-level {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }

        .progress-info {
            text-align: right;
        }

        .points-display {
            font-size: 2.8em;
            font-weight: bold;
            color: #333;
        }

        .points-value {
            color: #FFD700;
        }

        .progress-bar-container {
            height: 10px;
            width: 200px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #28a745;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        /* ==================== 模組列表樣式 ==================== */
        .modules-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .module-card {
            background-color: #fdfdfd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border-left: 6px solid transparent;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .module-card.status-completed {
            border-left-color: #28a745;
            background-color: #e8f5e9;
        }

        .module-card.status-in-progress {
            border-left-color: #ffc107;
            background-color: #fffde7;
        }

        .module-card.status-not-started {
            border-left-color: #6c757d;
            background-color: #f8f9fa;
        }

        .module-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .module-card h3 {
            font-size: 1.3em;
            margin: 0;
            color: #2c3e50;
        }

        .module-card .status-label {
            font-size: 0.9em;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 5px;
            color: white;
            background-color: #6c757d;
        }
        .module-card.status-completed .status-label { background-color: #28a745; }
        .module-card.status-in-progress .status-label { background-color: #ffc107; }

        .module-card .subtitle {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .module-card .points {
            font-weight: bold;
            color: #FF8C00;
        }

        /* ==================== 模組頁面樣式 ==================== */
        #modulePage {
            display: none;
        }

        .video-player-container {
            margin: 20px 0;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #videoPlayer {
            width: 100%;
            height: 500px;
            display: block;
        }

        /* ==================== 證書頁面樣式 ==================== */
        #certificatePage {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .certificate-container {
            width: 100%;
            max-width: 800px;
            min-height: 600px;
            padding: 20px;
            border: 5px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            font-family: 'Times New Roman', serif;
            position: relative;
        }

        .certificate-content {
            padding: 30px;
        }

        .certificate-content h1 {
            font-size: 3.5em;
            color: #2c3e50;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .award-text, .completion-text {
            font-size: 1.3em;
            margin: 8px 0;
            color: #555;
        }

        .recipient-name {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5em;
            color: #006064;
            margin: 30px 0;
            font-weight: bold;
        }

        .course-name {
            font-size: 1.8em;
            font-weight: bold;
            color: #444;
            margin-top: 15px;
        }

        .details {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin-top: 60px;
            width: 100%;
            font-size: 1.1em;
        }

        .signature-section, .date-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .signature-line {
            width: 220px;
            height: 2px;
            background-color: #333;
            margin-bottom: 8px;
        }

        .date-text {
            font-style: italic;
            color: #666;
            margin-top: 5px;
        }

        .download-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: #007bff;
        }
        .download-button:hover {
            background-color: #0056b3;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px auto;
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .progress-info {
                text-align: left;
                width: 100%;
            }
            .modules-list {
                grid-template-columns: 1fr;
            }
            #videoPlayer {
                height: 250px;
            }
            .certificate-container {
                padding: 15px;
                min-height: 400px;
            }
            .certificate-content h1 {
                font-size: 2.5em;
            }
            .recipient-name {
                font-size: 2em;
            }
            .course-name {
                font-size: 1.3em;
            }
            .details {
                flex-direction: column;
                gap: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="dashboard">
            <div class="dashboard-header">
                <div class="user-info">
                    <h2>您好，<span id="userNameDisplay">訪客</span>！</h2>
                    <p class="user-level" id="userLevelDisplay">初階學徒</p>
                </div>
                <div class="progress-info">
                    <span class="points-display">
                        <span class="points-value" id="userPointsDisplay">0</span> 點
                    </span>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <main class="modules-list" id="modulesList">
                <h3>課程列表</h3>
            </main>
        </div>

        <div id="modulePage">
            <button id="backToDashboardBtn">← 返回課程列表</button>
            <h2 id="moduleTitle"></h2>
            <p id="moduleSubtitle"></p>
            <div class="video-player-container">
                <video id="videoPlayer" controls preload="metadata"></video>
            </div>
        </div>

        <div id="certificatePage">
            <div class="certificate-container" id="certificateContent">
                <div class="certificate-content">
                    <h1>結業證書</h1>
                    <p class="award-text">
                        此證書授予
                    </p>
                    <h2 class="recipient-name" id="certificateUserName"></h2>
                    <p class="completion-text">
                        已成功完成
                    </p>
                    <p class="course-name" id="certificateCourseName"></p>
                    <div class="details">
                        <div class="signature-section">
                            <span class="signature-line"></span>
                            <p>課程講師簽名</p>
                        </div>
                        <div class="date-section">
                            <p>頒發日期</p>
                            <p class="date-text" id="certificateCompletionDate"></p>
                        </div>
                    </div>
                </div>
            </div>
            <button id="downloadCertificateBtn" class="download-button">下載證書</button>
            <button id="backFromCertificateBtn" class="download-button">返回主頁</button>
        </div>
    </div>

    <script>
        // ==================== 模擬資料庫與遊戲狀態 ====================
        let currentUserState = {
            userId: 'guest-user',
            userName: '訪客',
            points: 0,
            level: '初階學徒',
            currentModuleIndex: -1,
            modules: [
                {
                    title: '0. 為何要創業', subtitle: '了解自己適合創業嗎?', content: '要找工作還是自己當老闆',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1gbZn2DTvHiE2B_G06nERXb-Q7AuQvFIh/preview', videoProgress: 0
                },
                {
                    title: '1. 市場調查', subtitle: '我的競爭對手是誰？', content: '只有進行市場調查才能幫助我們找到答案',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1U8qQb6Ob_0pLR-KxtTLDnYcuh0fqqFtW/preview', videoProgress: 0
                },
                {
                    title: '2. 目標客群分析', subtitle: '了解潛在顧客', content: '目標客群分析是針對你的美髮創業展店來識別。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1K4_D47lq7gVnBl-OFApHuedFwgC3KAjV/preview', videoProgress: 0
                },
                {
                    title: '3. 競爭者研究', subtitle: '制定有效策略', content: '競爭者研究是瞭解你的美髮創業展店在市場環境中的位置',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1O5YKOSNwJkiSZS_4sjJvEI0dwKD-CxnR/preview', videoProgress: 0
                },
                {
                    title: '4. 行業趨勢與需求評估', subtitle: '了解市場及需求者', content: '針對市場環境及人口變化做綜合評估',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1cC2envJ3VySRqNahyUsLbST1U5Nw-T2I/preview', videoProgress: 0
                },
                {
                    title: '5. 專業化美髮定位', subtitle: '具備獨特性', content: '沙龍如何在眾多競爭對手中脫穎而出',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1mx6dCQx22q7MVAMaiH3B5570xDGb8etg/preview', videoProgress: 0
                },
                {
                    title: '6. 選址與佈置', subtitle: '選址與佈置是沙龍創業的基石，也是成功的開始', content: '一個好的店址不僅能吸引目標客群，更能提升品牌形象。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1kvB1EkXtp1xxtduubgPEPKtc_uJu7eK4/preview', videoProgress: 0
                },
                {
                    title: '7. 服務專案', subtitle: '品牌就像是你的臉', content: '視覺吸引力、品牌故事、互動體驗。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/11M2Wpx8cTDlYxyzImPhtniOZUhLXtdiH/preview', videoProgress: 0
                },
                {
                    title: '8. 供應鏈管理', subtitle: '提升效率、降低成本', content: '良好的供應鏈管理能確保沙龍穩定經營。',
                    points: 100, completed: false, videoUrl: 'https://drive.google.com/file/d/1Aj3GeAjIP561kZbvQ34erVizzbJ5GcZq/preview', videoProgress: 0
                },
                {
                    title: '9. 人力資源規劃', subtitle: '人員招聘到團隊管理策略', content: '開設一間成功的沙龍，不僅需要好的地點和產品，還需要一支高效且團結的團隊。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/16yrBQAjmQYj5fwOPvvZ5m8LRE287YWQ2/preview', videoProgress: 0
                },
                {
                    title: '10. 高端客戶服務', subtitle: '為高端客戶提供專屬的服務體驗', content: '高端客戶不僅帶來穩定的收入，更能提升品牌形象。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1kXaekwIciXsdwGy4pKnCyuMkohfOzvo_/preview', videoProgress: 0
                },
                {
                    title: '11. 法律與合規', subtitle: '開設沙龍所需的法律知識與合規要求', content: '合法經營不僅能避免潛在風險，更能建立客戶與員工的信任。',
                    points: 50, completed: false, videoUrl: 'https://drive.google.com/file/d/1LmhYPbc-jUBJhtUWv11kIBoXy60yizrJ/preview', videoProgress: 0
                },
                {
                    title: '12. 財務管理流程', subtitle: '財務管理流程', content: '財務管理是每一位創業者都需要重視的核心環節。',
                    points: 100, completed: false, videoUrl: 'https://drive.google.com/file/d/18GQ8LguusbO7nKHRNl9dwdzFmRi1H-Be/preview', videoProgress: 0
                },
                {
                    title: '13. 低成本創業', subtitle: '低成本創業', content: '如何做低成本創業。',
                    points: 100, completed: false, videoUrl: 'https://drive.google.com/file/d/1gY-HmrC_qWmHTOJJ3vV_lnMiN32_RpEH/preview', videoProgress: 0
                },
                {
                    title: '14. 獲客變現', subtitle: '獲客變現', content: '低成本行銷也能獲客變現。',
                    points: 100, completed: false, videoUrl: 'https://drive.google.com/file/d/1XWDIlKWw_ueGTIhfW8tld2KPp1jD_TBt/preview', videoProgress: 0
                }
            ],
            certificateID: null
        };

        const playerLevelMap = [
            { threshold: 0, name: '初階學徒' },
            { threshold: 300, name: '中階經營者' },
            { threshold: 600, name: '高階策略師' },
            { threshold: 1200, name: '課程畢業生' }
        ];

        // ==================== DOM 元素取得 ====================
        const dashboardDiv = document.getElementById('dashboard');
        const modulePageDiv = document.getElementById('modulePage');
        const certificatePageDiv = document.getElementById('certificatePage');

        const userNameDisplay = document.getElementById('userNameDisplay');
        const userLevelDisplay = document.getElementById('userLevelDisplay');
        const userPointsDisplay = document.getElementById('userPointsDisplay');
        const progressBar = document.getElementById('progressBar');
        const modulesList = document.getElementById('modulesList');

        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        const moduleTitleElem = document.getElementById('moduleTitle');
        const moduleSubtitleElem = document.getElementById('moduleSubtitle');
        const videoPlayer = document.getElementById('videoPlayer');

        const certificateContentDiv = document.getElementById('certificateContent');
        const certificateUserNameElem = document.getElementById('certificateUserName');
        const certificateCourseNameElem = document.getElementById('certificateCourseName');
        const certificateCompletionDateElem = document.getElementById('certificateCompletionDate');
        const downloadCertificateBtn = document.getElementById('downloadCertificateBtn');
        const backFromCertificateBtn = document.getElementById('backFromCertificateBtn');


        // ==================== 視圖切換函式 ====================
        function showPage(pageId) {
            dashboardDiv.style.display = 'none';
            modulePageDiv.style.display = 'none';
            certificatePageDiv.style.display = 'none';

            if (pageId === 'dashboard') {
                dashboardDiv.style.display = 'flex';
                renderDashboard();
            } else if (pageId === 'module') {
                modulePageDiv.style.display = 'block';
            } else if (pageId === 'certificate') {
                certificatePageDiv.style.display = 'flex';
            }
        }

        // ==================== 渲染儀表板 ====================
        function renderDashboard() {
            userNameDisplay.textContent = currentUserState.userName;
            userLevelDisplay.textContent = currentUserState.level;
            userPointsDisplay.textContent = currentUserState.points;

            const totalPossiblePoints = 1200;
            const progressPercentage = (currentUserState.points / totalPossiblePoints) * 100;
            progressBar.style.width = `${Math.min(100, progressPercentage)}%`;

            modulesList.innerHTML = '<h3>課程列表</h3>';

            currentUserState.modules.forEach((module, index) => {
                const moduleCard = document.createElement('div');
                let statusText = '未開始';
                let cardClass = 'module-card status-not-started';

                if (module.completed) {
                    statusText = '已完成 ✅';
                    cardClass = 'module-card status-completed';
                } else if (module.videoProgress > 0) {
                    statusText = `進行中 (${module.videoProgress}%)`;
                    cardClass = 'module-card status-in-progress';
                }

                moduleCard.className = cardClass;
                moduleCard.innerHTML = `
                    <div class="card-header">
                        <h3>${index}. ${module.title}</h3>
                        <span class="status-label">${statusText}</span>
                    </div>
                    <p class="subtitle">${module.subtitle}</p>
                    <div class="card-footer">
                        <span class="points">+${module.points} 點</span>
                    </div>
                `;
                moduleCard.onclick = () => openModule(index);
                modulesList.appendChild(moduleCard);
            });

            const allModulesCompleted = currentUserState.modules.every(m => m.completed);
            const totalPointsThreshold = 1200;
            if (allModulesCompleted && currentUserState.points >= totalPointsThreshold && !currentUserState.certificateID) {
                showCertificate();
                currentUserState.certificateID = `CERT-${Date.now()}`;
                saveUserState();
            }
        }

        // ==================== 打開模組頁面 (修正後) ====================
        function openModule(index) {
            currentUserState.currentModuleIndex = index;
            const module = currentUserState.modules[index];

            moduleTitleElem.textContent = `${index}. ${module.title}`;
            moduleSubtitleElem.textContent = module.subtitle;
            videoPlayer.src = module.videoUrl;

            // 確保每次開啟新模組時，都先移除舊的事件監聽器
            videoPlayer.onloadedmetadata = null;
            videoPlayer.ontimeupdate = null;
            videoPlayer.onended = null;

            videoPlayer.onloadedmetadata = () => {
                if (module.videoProgress > 0 && module.videoProgress < 95) {
                    const confirmResume = confirm(`您上次觀看到 ${module.videoProgress}%，是否要從上次進度繼續播放？`);
                    if (confirmResume) {
                        videoPlayer.currentTime = (module.videoProgress / 100) * videoPlayer.duration;
                    }
                }
                videoPlayer.play();
            };

            let lastSavedProgress = module.videoProgress;
            videoPlayer.ontimeupdate = () => {
                const currentProgress = Math.floor((videoPlayer.currentTime / videoPlayer.duration) * 100);
                if (currentProgress > lastSavedProgress + 5 || currentProgress >= 95 || videoPlayer.paused) {
                    module.videoProgress = currentProgress;
                    saveUserState();
                    lastSavedProgress = currentProgress;
                }
            };
            
            // 修正：當影片結束時，直接強制將進度設為 100%
            videoPlayer.onended = () => {
                module.videoProgress = 100;
                completeModule(index);
            };

            showPage('module');
        }

        // ==================== 完成模組邏輯 (修正後) ====================
        function completeModule(moduleIndex) {
            const module = currentUserState.modules[moduleIndex];

            // 修正：取消這個檢查，因為 onended 事件已經保證了影片結束
            // if (module.videoProgress < 95) {
            //     alert('請確保影片觀看進度達到 95% 以上，才能完整獲得點數。');
            //     return;
            // }

            if (!module.completed) {
                module.completed = true;
                currentUserState.points += module.points;

                console.log(`恭喜！完成模組 ${moduleIndex}，獲得 ${module.points} 點數。`);

                const oldLevel = currentUserState.level;
                const newLevelObj = playerLevelMap.find(level => currentUserState.points >= level.threshold) || playerLevelMap[0];
                currentUserState.level = newLevelObj.name;

                if (oldLevel !== newLevelObj.name) {
                    alert(`恭喜！您已升級至 ${newLevelObj.name}！`);
                }
            }
            saveUserState();
            renderDashboard();
            alert('此模組已完成，點數已計入！');
        }

        // ==================== 渲染證書頁面 ====================
        function showCertificate() {
            certificateUserNameElem.textContent = currentUserState.userName;
            certificateCourseNameElem.textContent = '美髮沙龍經營創業課程';
            certificateCompletionDateElem.textContent = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            showPage('certificate');
        }

        // ==================== 保存與載入使用者狀態 (使用 localStorage 模擬) ====================
        const STORAGE_KEY = 'hairSalonGameUserState';

        function saveUserState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentUserState));
        }

        function loadUserState() {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                if (parsedState.modules.length < currentUserState.modules.length) {
                    const newModules = currentUserState.modules.slice(parsedState.modules.length);
                    parsedState.modules = parsedState.modules.concat(newModules.map(m => ({ ...m, videoProgress: 0, completed: false })));
                }
                currentUserState = parsedState;
            }
        }
        
        // 頁面啟動時執行
        window.onload = () => {
            loadUserState();
            renderDashboard();
        };

        // ==================== 事件監聽器 ====================
        backToDashboardBtn.onclick = () => {
            if (currentUserState.currentModuleIndex !== -1) {
                const module = currentUserState.modules[currentUserState.currentModuleIndex];
                if (module.videoProgress < 95 && !module.completed) {
                    alert('影片尚未看完，進度將會儲存。');
                }
            }
            videoPlayer.pause();
            showPage('dashboard');
        };

        // 下載證書功能
        downloadCertificateBtn.onclick = () => {
            const originalScrollY = window.scrollY;
            window.scrollTo(0, 0);

            setTimeout(() => {
                html2canvas(certificateContentDiv, {
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `結業證書-${currentUserState.userName}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    window.scrollTo(0, originalScrollY);
                });
            }, 100);
        };

        backFromCertificateBtn.onclick = () => showPage('dashboard');
    </script>
</body>
</html>